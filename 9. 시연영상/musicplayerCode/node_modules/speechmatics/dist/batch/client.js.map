{
  "version": 3,
  "sources": ["../../src/batch/client.ts"],
  "sourcesContent": ["import {\n  CreateJobResponse,\n  RetrieveTranscriptResponse,\n  RetrieveJobResponse,\n  DeleteJobResponse,\n  RetrieveJobsResponse,\n  JobConfig,\n  DataFetchConfig,\n  BatchTranscriptionConfig,\n} from '../types';\nimport { ConnectionConfig, ConnectionConfigFull } from '../config/connection';\nimport { QueryParams, request, SM_APP_PARAM_NAME } from '../utils/request';\nimport poll from '../utils/poll';\nimport RetrieveJobsFilters from '../types/list-job-filters';\nimport { BatchFeatureDiscovery } from '../types/batch-feature-discovery';\nimport {\n  SpeechmaticsConfigurationError,\n  SpeechmaticsResponseError,\n} from '../utils/errors';\n\nexport class BatchTranscription {\n  private config: ConnectionConfigFull;\n  private _apiKey: string | undefined = undefined;\n\n  get apiKey(): string | undefined {\n    return (\n      this._apiKey ??\n      (typeof this.config.apiKey === 'string' ? this.config.apiKey : undefined)\n    );\n  }\n\n  async refreshApiKey(): Promise<string> {\n    if (typeof this.config.apiKey === 'string') return this.config.apiKey;\n\n    const newKey = await this.config.apiKey();\n    this._apiKey = newKey;\n    return newKey;\n  }\n\n  constructor(config: string | ConnectionConfig) {\n    this.config = new ConnectionConfigFull(config);\n  }\n\n  private async refreshOnAuthFail<T>(\n    doRequest: (key: string) => Promise<T>,\n  ): Promise<T> {\n    try {\n      return await doRequest(this.apiKey ?? (await this.refreshApiKey()));\n    } catch (e) {\n      if (e instanceof SpeechmaticsResponseError && e.response.code === 401) {\n        return await doRequest(await this.refreshApiKey());\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  private async get<T>(\n    endpoint: string,\n    contentType?: string,\n    queryParams?: QueryParams,\n  ): Promise<T> {\n    return await this.refreshOnAuthFail((key: string) =>\n      request(\n        key,\n        this.config.batchUrl,\n        endpoint,\n        'GET',\n        null,\n        { ...queryParams, [SM_APP_PARAM_NAME]: this.config.appId },\n        contentType,\n      ),\n    );\n  }\n\n  private async post<T>(\n    endpoint: string,\n    body: FormData | null = null,\n    contentType?: string,\n  ): Promise<T> {\n    return await this.refreshOnAuthFail((key: string) =>\n      request(\n        key,\n        this.config.batchUrl,\n        endpoint,\n        'POST',\n        body,\n        { [SM_APP_PARAM_NAME]: this.config.appId },\n        contentType,\n      ),\n    );\n  }\n\n  private async delete<T>(endpoint: string, params?: QueryParams): Promise<T> {\n    return this.refreshOnAuthFail((key: string) =>\n      request(key, this.config.batchUrl, endpoint, 'DELETE', null, {\n        ...params,\n        [SM_APP_PARAM_NAME]: this.config.appId,\n      }),\n    );\n  }\n\n  /**\n   * The main method for transcribing audio files. It takes a url or a buffer and returns a promise with a transcript.\n   *\n   *\n   * @param config TranscribeConfig\n   * @returns Promise<RetrieveTranscriptResponse>. A promise that resolves to a transcript.\n   */\n  async transcribe(\n    input: JobInput,\n    jobConfig: Parameters<typeof this.createTranscriptionJob>[1],\n    format?: TranscriptionFormat,\n  ): Promise<RetrieveTranscriptResponse | string> {\n    if (this.config.apiKey === undefined)\n      throw new SpeechmaticsConfigurationError(\n        'Missing apiKey in configuration',\n      );\n\n    const submitResponse = await this.createTranscriptionJob(input, jobConfig);\n\n    if (submitResponse === null || submitResponse === undefined) {\n      throw 'Error: submitResponse is undefined';\n    }\n\n    await poll(\n      async () => {\n        const { job } = await this.getJob(submitResponse.id);\n        if (job.status === 'rejected') {\n          throw job.errors;\n        } else if (job.status === 'done') {\n          return true;\n        } else {\n          return false;\n        }\n      },\n      3000, // repeat every 3 seconds\n      15 * 60 * 1000, // 15 minutes timeout\n    );\n\n    return await this.getJobResult(submitResponse.id, format);\n  }\n\n  async createTranscriptionJob(\n    input: JobInput,\n    jobConfig: CreateJobConfig,\n  ): Promise<CreateJobResponse> {\n    if (this.config.apiKey === undefined)\n      throw new SpeechmaticsConfigurationError(\n        'Missing apiKey in configuration',\n      );\n\n    const config: JobConfig = {\n      ...jobConfig,\n      type: 'transcription',\n    };\n\n    const formData = new FormData();\n    if ('url' in input) {\n      config.fetch_data = input;\n    } else if ('data' in input) {\n      formData.append('data_file', input.data, input.fileName);\n    } else {\n      formData.append('data_file', input);\n    }\n    formData.append('config', JSON.stringify(config));\n\n    return this.post('/v2/jobs', formData);\n  }\n\n  async listJobs(\n    filters: RetrieveJobsFilters = {},\n  ): Promise<RetrieveJobsResponse> {\n    if (this.config.apiKey === undefined)\n      throw new SpeechmaticsConfigurationError(\n        'Missing apiKey in configuration',\n      );\n    return this.get('/v2/jobs', 'application/json', { ...filters });\n  }\n\n  async getJob(id: string): Promise<RetrieveJobResponse> {\n    if (this.config.apiKey === undefined)\n      throw new SpeechmaticsConfigurationError(\n        'Missing apiKey in configuration',\n      );\n    return this.get(`/v2/jobs/${id}`, 'application/json');\n  }\n\n  async deleteJob(id: string, force = false): Promise<DeleteJobResponse> {\n    if (this.config.apiKey === undefined)\n      throw new SpeechmaticsConfigurationError(\n        'Missing apiKey in configuration',\n      );\n    const params = force ? { force } : undefined;\n    return this.delete(`/v2/jobs/${id}`, params);\n  }\n\n  // No format, defaults to JSON-V2 with response body returned\n  async getJobResult(jobId: string): Promise<RetrieveTranscriptResponse>;\n  async getJobResult(\n    jobId: string,\n    format: 'json-v2',\n  ): Promise<RetrieveTranscriptResponse>;\n  // Text/SRT returns string\n  async getJobResult(jobId: string, format: 'text' | 'srt'): Promise<string>;\n  // If which precise format is unknown at compile time, could be either response body or string\n  async getJobResult(\n    jobId: string,\n    format?: TranscriptionFormat,\n  ): Promise<RetrieveTranscriptResponse | string>;\n  async getJobResult(\n    jobId: string,\n    format: TranscriptionFormat = 'json-v2',\n  ): Promise<RetrieveTranscriptResponse | string> {\n    if (this.config.apiKey === undefined)\n      throw new SpeechmaticsConfigurationError(\n        'Missing apiKey in configuration',\n      );\n    const params = { format: format === 'text' ? 'txt' : format };\n    const contentType =\n      format === 'json-v2' ? 'application/json' : 'text/plain';\n    return this.get(`/v2/jobs/${jobId}/transcript`, contentType, params);\n  }\n\n  async getDataFile(jobId: string) {\n    if (this.config.apiKey === undefined)\n      throw new SpeechmaticsConfigurationError(\n        'Missing apiKey in configuration',\n      );\n    return this.get(`/v2/jobs/${jobId}/data`, 'application/json');\n  }\n\n  async getFeatureDiscovery(): Promise<BatchFeatureDiscovery> {\n    return this.get('/v1/discovery/features');\n  }\n}\n\nexport type TranscriptionFormat = 'json-v2' | 'text' | 'srt';\n\nexport type JobInput =\n  | File\n  | { data: Blob; fileName: string }\n  | DataFetchConfig;\n\ntype CreateJobConfig = Omit<JobConfig, 'type' | 'fetch_data'> & {\n  transcription_config: BatchTranscriptionConfig;\n};\n"],
  "mappings": "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",
  "names": ["poll"]
}
